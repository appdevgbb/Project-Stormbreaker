apiVersion: v1
kind: ConfigMap
metadata:
  name: cm-adcirc
data:
  entrypoint.sh: |-
    #!/usr/bin/bash -l
    TEST_DIR="/mnt/output/"
    apt update
    apt install -y openssh-server
    mkdir -p /var/run/sshd; /usr/sbin/sshd

    NP=28
    SLOTS=14
    
    cd /mnt/scratchpad
    cp $TEST_DIR/{run.sh,TEST_2.zip} /mnt/scratchpad
    unzip TEST_2.zip
    cd TEST_2/

    adcprep --np $NP --partmesh > adcprep.txt
    adcprep --np $NP --prepall  >> adcprep.txt
   
    sleep 360d
    mpiexec --allow-run-as-root -np $NP -npernode $SLOTS --bind-to numa --map-by ppr:$SLOTS:node -hostfile /etc/volcano/mpiworker.host -x UCX_NET_DEVICES=mlx5_0:1 -mca ucx ^vader,tcp,openib,uct -x UCX_TLS=rc padcirc > padcirc_log.txt
    #mpiexec --allow-run-as-root -np $NP -npernode $SLOTS --mca plm_rsh_args "-p 2222" -hostfile /etc/volcano/mpiworker.host -x UCX_TLS=tcp -x UCX_NET_DEVICES=eth0 -mca coll_hcoll_enable 0 padcirc > padcirc_log.txt

FROM ubuntu:20.04

# Install dependencies  
RUN DEBIAN_FRONTEND=noninteractive \
    apt-get update && apt-get install -y \
    automake \
    autoconf \
    libtool \
    gcc \
    gfortran \
    wget \
    make \
    libxml2-dev \
    openssh-server \
    build-essential \
    m4 \
    vim

# Set environment variables for compilers  
ENV FC=gfortran
ENV CC=gcc
ENV LD_LIBRARY_PATH=/home/stormbreaker/install/lib


# Create necessary directories  
RUN mkdir -p /home/stormbreaker/src
RUN mkdir -p /home/stormbreaker/install

WORKDIR /home/stormbreaker/src

# Download sources  
RUN wget http://zlib.net/zlib-1.3.1.tar.gz
RUN wget www.hdfgroup.org/ftp/HDF5/current/src/hdf5-1.10.5.tar.gz
RUN wget https://github.com/Unidata/netcdf-c/archive/refs/tags/v4.9.2.tar.gz
RUN wget https://downloads.unidata.ucar.edu/netcdf-fortran/4.6.1/netcdf-fortran-4.6.1.tar.gz

# Install zlib  
RUN tar -xzvf zlib-1.3.1.tar.gz && \
    cd zlib-1.3.1 && \
    ./configure && \
    make test && \
    make install prefix=/home/stormbreaker/install && \
    cd ../

# Install hdf5  
RUN tar -xzvf hdf5-1.10.5.tar.gz && \
    cd hdf5-1.10.5 && \
    ./configure -with-zlib=/home/stormbreaker/install -prefix=/home/stormbreaker/install -enable-fortran && \
    make && \
    make check && \
    make install && \
    cd ../

# Install netcdf c library  
RUN t


# Download and install adcirc  
RUN wget https://github.com/adcirc/adcirc/releases/download/v55.02/adcirc_v55.02.tar.gz && \
    tar xvzf adcirc_v55.02.tar.gz && \
    cd adcirc_v55.02/work && \
    make clobber && \
    make adcirc && \
    make padcirc && \
    cd ../thirdparty/swan && \
    make clobber && \
    make config && \
    sed -i 's!(../work/odir4)!../\1!g' macros.inc && \
    make punswan && \
    make clobber && \
    cd ../../work && \
    make adcswan && \
    make padcswan && \
    make adcprep SWAN=enable && \
    make hstime && \
    make aswip && \
    for i in adcirc adcprep adcswan aswip hstime padcirc padcswan; do cp $i /home/stormbreaker/install/bin/; done

# Set the default command for the image  
CMD ["bash"]
